!function(e,t){function o(e){this.create(e)}var s,a;t.PhotoDropzone=(s=e,(a=t).npm.objectAssign(o.prototype,a.npm.EventEmitter.prototype,{template:psdata_photos_dropzone.template,templatePreview:psdata_photos_dropzone.template_preview,create:function(e){this.uploading=0,this.$el=s(this.template).appendTo(e),this.$photos=this.$el.find(".ps-js-photos"),this.$file=this.$el.find("input[type=file]"),this.$upload=this.$el.find(".ps-js-upload"),this.$upload.on("click",s.proxy(this.onUpload,this)),a.isWebdriver()&&(this.uploadInit(),this.uploadInitialized=!0)},empty:function(e){"save"!==e&&this.removeTempFiles(this.getPhotos()),this.$photos.find(".ps-js-preview").remove(),this.emit("photo_empty")},movePhotos:function(e,t){photos=this.getPhotos(),_.isArray(photos)&&1<=photos.length&&(e={user_id:peepsodata.currentuserid,old_group_id:e,group_id:t,photo:photos,_wpnonce:this.$el.find("[name=_wpnonce_remove_temp_files]").val(),_wp_http_referer:this.$el.find("[name=_wp_http_referer]").val()},e=a.observer.applyFilters("photos_move_temp_files",e),a.postJson("photosajax.move_temp_files",e))},getPhotos:function(){var t=[];return this.$photos.find(".ps-js-preview").each(function(){var e=s(this).data("id");t.push(e)}),t},upload:function(){this.uploadInitialized||(this.uploadInit(),this.uploadInitialized=!0),this.$file.trigger("click")},uploadInit:function(){var o=peepsodata.currentuserid;this.$file.psFileupload({singleFileUploads:!0,sequentialUploads:!1,replaceFileInput:!0,dropZone:this.$el,pasteZone:null,dataType:"json",url:peepsodata.ajaxurl_legacy+"photosajax.upload_photo",beforeSend:function(e){e.setRequestHeader("X-PeepSo-Nonce",peepsodata.peepso_nonce)},add:s.proxy(this.uploadAdd,this),submit:s.proxy(function(e,t){t.formData=a.observer.applyFilters("photos_upload_req",{user_id:o},this)},this),progress:s.proxy(this.uploadProgress,this),done:s.proxy(this.uploadDone,this)}),this.on("photo_added",this.uploadAdded),this.on("photo_removed",this.uploadRemoved)},uploadAdd:function(e,t){this.$file=this.$el.find("input[type=file]"),this.validate(t)},uploadAdded:function(e,t){var o=s(this.templatePreview);o.find(".ps-js-progress").css({width:1}),o.on("click",".ps-js-rotate-l",{id:t,dir:"ccw"},this.onRotate.bind(this)),o.on("click",".ps-js-rotate-r",{id:t,dir:"cw"},this.onRotate.bind(this)),o.on("click",".ps-js-remove",{id:t},s.proxy(this.onRemove,this)),o.addClass("ps-js-preview-"+t),e.files[0].name.match(/\.gif$/i)&&o.find(".ps-js-rotate-l, .ps-js-rotate-r").remove(),this.$upload.before(o),e.preview=o,this.resetSortable()},uploadRemoved:function(e){var t=this.$photos.find(".ps-js-preview-"+e);t.fadeOut(500,s.proxy(function(){t.remove(),this.$photos.find(".ps-js-preview").length?this.resetSortable():this.emit("photo_empty")},this))},uploadProgress:function(e,t){var o=t.preview,t=100*t.loaded/t.total;t=Math.max(0,Math.min(98,t)),t+="%",o.find(".ps-js-progress").stop().animate({width:t},2e3),this.beforeUnloadHandler||(this.beforeUnloadHandler=function(){return!0},a.observer.addFilter("beforeunload",this.beforeUnloadHandler))},uploadDone:function(e,t){var o=t.preview,t=t.result;this.beforeUnloadHandler&&(a.observer.removeFilter("beforeunload",this.beforeUnloadHandler),this.beforeUnloadHandler=null),t.success?(o.data("id",t.data.files[0]),o.find(".ps-js-img").html('<img src="'+t.data.thumbs[0]+'" />'),o.find(".ps-js-rotate-l, .ps-js-rotate-r").show(),o.find(".ps-js-remove").show(),o.find(".ps-js-progress").stop().animate({width:"100%"},1e3,function(){setTimeout(function(){o.find(".ps-js-progressbar").fadeOut()},1e3)})):t.errors&&t.errors.length&&(t=t.errors.join("<br/>"),(t=s("<div/>").append(t).attr("title",t)).css({color:"red",fontSize:".8em",height:"100%",overflow:"hidden",padding:4}),o.find(".ps-js-progress").stop().hide(),o.find(".ps-js-rotate-l, .ps-js-rotate-r").hide(),o.find(".ps-js-remove").show(),o.find(".ps-js-img").html(t)),this.emit("photo_upload_done",--this.uploading)},validate:function(e){var t=(new Date).getTime()+Math.floor(1e3*Math.random());this.emit("photo_added",e,t),this.emit("photo_upload_start",++this.uploading),this.validateQueue||(this.validateQueue=[]),this.validateQueue.push([e,t]),this._validate()},_validate:_.throttle(function(){var t,o,e,i;this._validateProgress||(i=this.validateQueue.shift())&&(this._validateProgress=!0,t=i[0],o=i[1],i=t.files[0],/\.(gif|jpg|jpeg|png|tif|tiff|webp)$/i.test(i.name)?(e=_.filter(this.getPhotos(),function(e){return e}),i=a.observer.applyFilters("photos_validate_req",{size:parseInt(i.size),filesize:parseInt(i.size),photos:e.length+1},this),s.ajax({type:"POST",url:peepsodata.ajaxurl_legacy+"photosajax.validate_photo_upload",data:i,dataType:"json",beforeSend:function(e){e.setRequestHeader("X-PeepSo-Nonce",peepsodata.peepso_nonce)}}).done(s.proxy(function(e){e.success?t.submit().done(s.proxy(function(){setTimeout(s.proxy(function(){this._validateProgress=!1,this._validate()},this),1e3)},this)).fail(s.proxy(function(e){this.emit("photo_upload_done",--this.uploading),this.validateFail(o),this._validateProgress=!1,this._validate()},this)):e.errors&&e.errors.length&&(this.emit("photo_upload_done",--this.uploading),this.validateError(o,e.errors.join("<br/>")),this._validateProgress=!1,this._validate())},this)).fail(s.proxy(function(e){this.emit("photo_upload_done",--this.uploading),this.validateFail(o),this._validateProgress=!1,this._validate()},this))):(this.emit("photo_upload_done",--this.uploading),this.validateError(o,peepsophotosdata.error_unsupported_format),this._validateProgress=!1,this._validate()))},1e3),validateError:function(e,t){e=this.$photos.find(".ps-js-preview-"+e),t=s("<div/>").append("<span>"+t+"</span>").attr("title",t);t.css({color:"red",display:"table",fontSize:".8em",height:"100%",overflow:"hidden",padding:4}).find("span").css({display:"table-cell",verticalAlign:"middle"}),e.find(".ps-js-progress").stop().hide(),e.find(".ps-js-rotate-l, .ps-js-rotate-r").hide(),e.find(".ps-js-remove").show(),e.find(".ps-js-img").html(t)},validateFail:function(e){var t=psdata_photos_dropzone.text_upload_failed_notice,e=this.$photos.find(".ps-js-preview-"+e),t=s("<div/>").append("<span>"+t+"</span>").attr("title",t);t.css({color:"red",display:"table",fontSize:".8em",height:"100%",overflow:"hidden",padding:4}).find("span").css({display:"table-cell",verticalAlign:"middle"}),e.find(".ps-js-progress").stop().hide(),e.find(".ps-js-rotate-l, .ps-js-rotate-r").hide(),e.find(".ps-js-remove").show(),e.find(".ps-js-img").html(t)},resetSortable:function(){this.$photos.sortable({items:".ps-js-preview",tolerance:"pointer",placeholder:"ps-js-dummy-class"})},destroy:function(){this.removeTempFiles(this.getPhotos()),this.$el.remove()},removeTempFiles:function(e){_.isArray(e)&&1<=e.length&&(e={user_id:peepsodata.currentuserid,photo:e,_wpnonce:this.$el.find("[name=_wpnonce_remove_temp_files]").val(),_wp_http_referer:this.$el.find("[name=_wp_http_referer]").val()},e=a.observer.applyFilters("photos_remove_temp_files",e),a.postJson("photosajax.remove_temp_files",e))},onUpload:function(){this.upload()},onRotate:function(e){var t=e.data.id,e=e.data.dir,o=this.$photos.find(".ps-js-preview-"+t),t=o.data("id"),i=s("<div />").css({background:"rgba(255, 255, 255, .5)",position:"absolute",top:0,left:0,right:0,bottom:0});i.appendTo(o);t=a.observer.applyFilters("photos_rotate_req",{photo:t,direction:e},this);a.ajax.post("photosajax.rotate_photo",t).done(e=>{e.success&&(o.data("id",e.data.file),o.find(".ps-js-img").html(`<img src="${e.data.thumb}" />`))}).always(()=>i.remove())},onRemove:function(e){var e=e.data.id,t=this.$photos.find(".ps-js-preview-"+e);this.removeTempFiles([t.data("id")]),this.emit("photo_removed",e)},triggerUpload:function(){this.upload()},addDroppable:function(t){var o=setInterval(s.proxy(function(){var e;this.$el.parent()&&(clearInterval(o),this.uploadInitialized||(this.uploadInit(),this.uploadInitialized=!0),e=(e=this.$file.psFileupload("option","dropZone")).add(t),this.$file.psFileupload("option","dropZone",e))},this),1e3)}}),o)}(jQuery,peepso);